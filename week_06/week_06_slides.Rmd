---
title: "Tidying data and building plots with R"
subtitle: "Reproducible reporting course: Week 6"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(
  dpi = 300,
  fig.retina = 3)

```

```{r xaringan-themer, include=FALSE, warning=FALSE}

library(xaringanthemer)
style_duo_accent(
  primary_color = "#50b4c8",
  secondary_color = "#215e6b",
  inverse_header_color = "#FFFFFF",
  header_font_google = google_font("Overpass"),
  code_font_google = google_font("Fira Code", "500"),
  text_font_size = "1.1rem",
  code_font_size = "0.8rem",
  link_color = "#fc530e"
)

```

## Before we get started

If you'd like to code-along with the examples included in this slidedeck, make sure you have added this line to the .Renviron file in the local folder for your course project repo:

<br />

`PATH="${RTOOLS40_HOME}\usr\bin;${PATH}"`

<br />

The .Renviron file defines project-specific environment variables, so this line points R and R Studio to where you have Rtools40 installed on your local machine.

---
class: inverse, center, middle

# Summertime, and the plotting is easy
## (with R and {ggplot2})

---

.pull-left[
With the `{ggplot2}` R package, we can make a basic plot with a few lines of code!

```{r ggplot2_basic_example, fig.show = "hide"}

# Load the library

# To install {ggplot2} for the first time,
# or to update your installation, run this line:
# install.packages("ggplot2")

library(ggplot2)

# Build a plot

# Note: The "ToothGrowth" data set is one of
# many data sets that are included with base R.
# That means you don't have to import it!

p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len))
p <- p + geom_bar(stat = "identity")

# Display the plot by calling the object "p"

p

```
]

--

.pull-right[
```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---
background-image: url('images/ggplot2_masterpiece_bg.png')
background-position: center
background-size: contain

## Introduction to {ggplot2}

.pull-left[
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<small>Image credit: [Allison Horst](https://github.com/allisonhorst/stats-illustrations)</small>
]

.pull-right[
`{ggplot2}` is a powerful, flexible, and widely used R package for making plots.

<br />

What makes it so useful is that it is based on a **layered grammar of graphics**, "a coherent system for describing and building graphs" [(Grolemund & Wickham, 2017)](https://r4ds.had.co.nz/data-visualisation.html#introduction-1).

<br />

The grammar of graphics defines a logic for what makes up a plot and how data is mapped to aesthetic features.
]

---

## Layered grammar of graphics

As described by [Wickham (2010)](https://vita.had.co.nz/papers/layered-grammar.html), take a set of graphical elements...

<center><img src="images/lgog_fig1.png"></center>

---

## Layered grammar of graphics

...then layer the elements on top of one another to produce a plot.

<center><img src="images/lgog_fig2.png"></center>

---
background-image: url('images/glen-carrie-J-PYjAqd2HU-unsplash_bg.jpg')
background-position: center
background-size: contain    

## An analogy: Painting and {ggplot2}

Imagine a simplified process for painting:

--

- You have something to paint on (e.g., a canvas),

--

- You have a rough idea of what you want the finished piece to look like, and

--

- You paint in layers from background to foreground.

<br />

--

When building plots with `{ggplot2}`:

- Your "canvas" is the plotting area and coordinate system,

--

- You have a type of plot in mind (e.g., a bar plot, one colour per group), and

--

- You write code for each plot layer in order, from background to foreground.

<small>Image credit: [Glen Carrie](https://unsplash.com/photos/J-PYjAqd2HU)</small>

---

## Understanding {ggplot2} code

.pull-left[
The first plot shown in this slidedeck is reproduced on the right.

Now let's look at the code used to produce this plot!
]

.pull-right[
```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---

## Understanding {ggplot2} code

.pull-left[
```{r eval = FALSE}

p <- ggplot( #<<
  data = ToothGrowth,
  aes(x = supp, y = len))
p <- p + geom_bar(stat = "identity")

```
]

.pull-right[
We create an object called `p` to store information about the plot we are building.

We use the `ggplot()` function to create a "canvas" for our plot - the plotting area and coordinate system.
]

---

## Understanding {ggplot2} code

.pull-left[
```{r eval = FALSE}

p <- ggplot(
  data = ToothGrowth, #<<
  aes(x = supp, y = len))
p <- p + geom_bar(stat = "identity")

```
]

.pull-right[
Inside the `ggplot()` function, `data = ToothGrowth` specifies the data set to use for the plot.
]

---

## Understanding {ggplot2} code

.pull-left[
```{r eval = FALSE}

p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len)) #<<
p <- p + geom_bar(stat = "identity")

```
]

.pull-right[
Here we have the `aes()` function nested inside the `ggplot()` function; `aes()` is short for "aesthetics".

In the `aes()` function, we specify what variables we are going to plot on the x axis (`x = supp`, a grouping variable) and on the y axis (`y = len`, a numeric variable).
]

---

## Understanding {ggplot2} code

.pull-left[
```{r eval = FALSE}

p <- ggplot( #<<
  data = ToothGrowth, #<<
  aes(x = supp, y = len)) #<<
p <- p + geom_bar(stat = "identity")

```
]

.pull-right[
With the first 3 lines of code, we have defined all the fundamental information needed to generate any plot:

- We have created the plotting area (using the `ggplot()` function),
- We have identified the data source (using the `data` argument), and
- We have specified which variables to plot on the x and y axes (using the `x` and `y` arguments).
]

---

## Understanding {ggplot2} code

.pull-left[
```{r eval = FALSE}

p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len))
p <- p + geom_bar(stat = "identity") #<<

```
]

.pull-right[
On a new line, we update the object `p` to add a new layer to the plot.

In `{ggplot2}` code, `p <- p +` means *"assign to the object `p` the existing value of `p` plus a new layer of plotting information"*.

In this case, we specify a new layer using the `geom_bar()` function. `geom` is short for geometries - i.e., shapes!

`geom_bar()` is used to create bar plots. The `stat = "identity"` argument indicates that we want to plot summed values.
]

---

## Understanding {ggplot2} code

.pull-left[
When you're ready to see what your plot looks like, call the object you've created to store the plotting information:

```{r eval = FALSE}

p

```

*Et voilà!*
]

.pull-right[
```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---

## Okay, I know what you're thinking...

.pull-left[
This plot isn't very visually appealing. Yet.

<br />

Let's modify the code we've used to build this plot to adjust how it looks.
]

.pull-right[
```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---
class: inverse, center, middle

# But first...

## A short description of the ToothGrowth data set

---

## ToothGrowth data set

In your R console, you can check details about the built-in `ToothGrowth` data set by typing:

```{r eval = FALSE}

help(ToothGrowth)

```

--

> "The response is the length of odontoblasts (cells responsible for tooth growth) in 60 guinea pigs. Each animal received one of three dose levels of vitamin C (0.5, 1, and 2 mg / day) by one of two delivery methods, orange juice or ascorbic acid (a form of vitamin C and coded as VC)."

--

The data set includes 60 observations and 3 variables:

- `len`: Tooth length.
- `supp`: Supplement type (VC or OJ).
- `dose`: Dose of vitamin C in mg / day (either 0.5, 1, or 2 mg / day).

---

## ToothGrowth data set

.pull-left[
On the right is a scrollable table you can use to inspect the `ToothGrowth` data set.

Alternatively, you could type the following into your R console to generate an interactive table viewer inside your R session:

```{r eval = FALSE}

View(ToothGrowth)

```
]

.pull-right[
```{r echo = FALSE}

library(kableExtra)

ToothGrowth %>%
  kbl() %>%
  scroll_box(width = "300px", height = "350px")

```
]

---
class: inverse, center, middle

# Modifying our starter plot

---

## 

.pull-left[
How might we improve this plot using the `ToothGrowth` data set?

```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

--

.pull-right[
Some suggestions:

1. Fill the bars with different colours, to visually distinguish between supplement types.

2. Write better x and y axis labels.

3. Add a plot title.
]

---

## Fill the bars with different colours

.pull-left[
In the code below, we've modified the `aes()` function to add the argument `fill = supp`.

```{r ggplot2_basic_example_mod1a, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len, fill = supp)) #<<
p <- p + geom_bar(stat = "identity")

# Display the plot
p

```

This means: fill geometric shapes based on values in the `supp` variable (either `"OJ"` or `"VC"`).
]

--

.pull-right[
```{r ref.label = "ggplot2_basic_example_mod1a", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

--

<small>Note that `{ggplot2}` includes "useful defaults" to make plotting easier. In this case, the default colour palette has been invoked and a legend is also displayed by default.</small>

---

## Fill the bars with different colours

.pull-left[
The legend duplicates info that is presented on the x axis. To remove the legend, we add a layer to modify the plot's theme elements using the `theme()` function and specifically, the `legend.position` argument.

```{r ggplot2_basic_example_mod1b, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len, fill = supp))
p <- p + geom_bar(stat = "identity")
p <- p + theme( #<<
  legend.position = "none") #<<

# Display the plot
p

```
]

--

.pull-right[
```{r ref.label = "ggplot2_basic_example_mod1b", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

--

<small>Bonus: What happens if you specify `legend.position = "top"`? What about `legend.position = "left"`? Try these options out in your R session to check your programming intuition. `r emo::ji("thumbs_up")`</small>

---

## Write better y and x axis labels

.pull-left[
To specify x and y axis labels, we add a layer using the `labs()` function.

```{r ggplot2_basic_example_mod2, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len, fill = supp))
p <- p + geom_bar(stat = "identity")
p <- p + labs( #<<
  x = "Supplement type", #<<
  y = "Sum of tooth length growth") #<<
p <- p + theme(
  legend.position = "none")

# Display the plot
p

```
]

--

.pull-right[
```{r ref.label = "ggplot2_basic_example_mod2", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

--

<small>Notice that I have added the `labs()` layer before the `theme()` layer. A common practice is to specify plot theme elements as the last step in the "background-to-foreground" approach of building `{ggplot2}` plots.</small>

---

## Add a plot title

.pull-left[
Inside the `labs()` layer, specify the `title` argument to add a plot title.

```{r ggplot2_basic_example_mod3, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = ToothGrowth,
  aes(x = supp, y = len, fill = supp))
p <- p + geom_bar(stat = "identity")
p <- p + labs(
  title = "Guinea pigs on juice", #<<
  x = "Supplement type",
  y = "Sum of tooth length growth")
p <- p + theme(
  legend.position = "none")

# Display the plot
p

```
]

--

.pull-right[
```{r ref.label = "ggplot2_basic_example_mod3", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---

## Compare the pair

.pull-left[
From this...
```{r ref.label = "ggplot2_basic_example", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

--

.pull-right[
To this!
```{r ref.label = "ggplot2_basic_example_mod3", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---
class: inverse, center, middle

# Activity 1

## Build your own plot with {ggplot2}

---

## Build a plot using a built-in data set

Task: Use the `mtcars` built-in data set to make a plot.

--

<br />

Part 1. Familiarise yourself with `mtcars`:

- Check the data set description. In your R console, run `help(mtcars)`.
- Visually inspect the data set. In your R console, run `View(mtcars)`.

--

<br />

Part 2. Build one of the following plots using the `{ggplot2}` package:

- A scatterplot of quarter mile time (`qsec`) vs. miles per gallon (`mpg`).
- A bar plot, counting the number of cars with 4, 6, or 8 cylinders (`cyl`).
- A box plot of car weights (`wt`) by engine shape (`vs`).
- Or make up your own!

---

## Helpful resources

Wickham, H., Navarro, D., & Pedersen, T.L. (n.d.). [*ggplot2: Elegant Graphics for Data Analysis*](https://ggplot2-book.org/)

--

<br />

Chang, W. (2020). [*R Graphics Cookbook*](https://r-graphics.org/) (2nd ed.). From Chapter 3 onwards, `{ggplot2}` is used to build plots.

--

<br />

Google search for resources and forum posts related to what you're trying to achieve. I find it helpful to start my search string with *"ggplot2 how to"* `r emo::ji("balloon")`

---

## Minimal worked examples

Have a go at building your plot first before peeking at the worked examples on the next few slides!

<center>
```{r, out.width = "60%", echo = FALSE}

knitr::include_graphics("images/joakim-honkasalo-GZa4QFmv0Zg-unsplash.jpg")

```
<br />
<br />
<small>Image credit: <a href="https://unsplash.com/photos/GZa4QFmv0Zg" target="_blank">Joakim Honkasalo</a></small>
</center>

---

## Example: Quarter mile time vs. miles per gallon

.pull-left[
```{r mtcars_example1, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = mtcars,
  aes(x = qsec, y = mpg))
p <- p + geom_point()

# Display the plot
p

```
]

.pull-right[
```{r ref.label = "mtcars_example1", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---

## Example: Number of cars with 4, 6, or 8 cylinders

.pull-left[
```{r mtcars_example2, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = mtcars,
  aes(x = cyl))
p <- p + geom_bar(stat = "count")

# Display the plot
p

```
]

.pull-right[
```{r ref.label = "mtcars_example2", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---

## Example: Car weights by engine shape

.pull-left[
```{r mtcars_example3, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = mtcars,
  aes(x = vs, y = wt, group = vs))
p <- p + geom_boxplot()

# Display the plot
p

```
]

.pull-right[
```{r ref.label = "mtcars_example3", fig.width = 4, fig.height = 3, echo = FALSE}

```
]

---
class: inverse, center, middle

# Plotting data from the SQL Learning datamart

---

## Import data...

.pull-left[
Last week, we learned how to import data from SQL into R, using code that looks something like what is shown on the right.

Here I connect to the SQL datamart using the `{RODBC}` package.

Then, using the `sqlQuery()` function, I read data from the datamart and store it in an object that I've named `source_data` (highlighted).
]

.pull-right[
```{r import_data_from_sql, cache = TRUE}

# Load libraries

library(RODBC)

# Establish ODBC connection

con <- odbcConnect(
  "HPSNZ_Datamart",
  uid = Sys.getenv("datamart_user"),
  pwd = Sys.getenv("datamart_pwd"))

# Read data into R

source_data <- sqlQuery( #<<
  con,
  "SELECT * FROM [CME_HPSNZ].[report].[vw_p2p_age]")

# Close the ODBC connection

odbcClose(con)

```
]

---

## Import data...then build a plot!

.pull-left[
```{r build_plot_first_example, fig.show = "hide"}

# Build the plot
p <- ggplot(
  data = source_data, # Specify the data source
  aes(x = age, y = p2p_intake)) # Specify variables for the x and y axes
p <- p + geom_boxplot() # Create boxplots

# Call the object to display the plot
p

```
]

--

.pull-right[
```{r ref.label = "build_plot_first_example", fig.width = 6, fig.height = 4, echo = FALSE}

```
]

---

## A closer look at report.vw_p2p_age

---

## Some plotting ideas

---
class: inverse, center, middle

# Data types in R

---
class: inverse, center, middle

# Going further with tidy data

---

## Recap: Tidy data principles

---

## Tidy data and {ggplot2}

`{ggplot2}` is part of the `{tidyverse}` set of packages, so it is designed to work well with other R packages that adhere to tidy data principles.

--

`{ggplot2}` works best with **tidy data** that is in **long format**.

---

## Remind me...what is tidy data?

Data is tidy when:

- Columns are variables,

--

- Rows are observations, and

--

- Every row is at a consistent level of observation.

---

## What is long data?

Data is long when factor levels are stored within a column, and observation values are stored in a separate column [(Harrison & Pius, 2020)](https://argoshare.is.ed.ac.uk/healthyr_book/reshaping-data-long-vs-wide-format.html).

---

## Example of long data

.pull-left[
```{r long_format_example, echo = FALSE, message = FALSE}

library(palmerpenguins)
library(dplyr)
library(knitr)
library(kableExtra)

penguins %>%
  select(species, sex, body_mass_g) %>%
  kable() %>%
  scroll_box(width = "400px", height = "450px")

```
]

.pull-right[
The example on the left uses data from the `{palmerpenguins}` R package.

There are two factor variables ("species" and "sex"), each stored as columns.

Observation values for body mass are stored in the variable "body_mass_g". Each row corresponds to one penguin.

*****

*Can you identify the factor levels within "species"? Hint: There are 3 levels.*

]

---

## What is wide data?

Data is wide when some or all of the columns are levels of a factor [(Harrison & Pius, 2020)](https://argoshare.is.ed.ac.uk/healthyr_book/reshaping-data-long-vs-wide-format.html).

Wide data tends to be easier for humans to read. For example: You might wrangle data into wide format when you want to display it in a table. We'll get to that next week!

---

## Example of wide data

In the example below, data from the `{palmerpenguins}` package has been transposed from long to wide format. The factor variable is "species" and the levels within that factor are "Adelie", "Chinstrap", and "Gentoo". The values are the mean body mass in grams for males and females of each species.

```{r wide_format_example, echo = FALSE}

library(tidyr)

penguins %>%
  select(species, sex, body_mass_g) %>%
  filter(!is.na(sex)) %>%
  group_by(sex, species) %>%
  summarise(
    body_mass_g_mean = round(mean(body_mass_g), 0),
    .groups = "drop") %>%
  pivot_wider(
    id_cols = "sex",
    names_from = "species",
    values_from = "body_mass_g_mean") %>%
  kable()

```

---
class: inverse, center, middle

# Activity 3: Getting fancy

## Wrangling data and customising plots

---
class: inverse, center, middle

# Course project

## Design your own plot!

---

## Getting set up

**If you've been using R while following these slides, now is a good time to clear your workspace and restart R.**

Using Windows explorer, navigate to the local folder for your course project repo, then open the .Rproj file to open up a new session of RStudio from inside your project repo.

Open the .Rmd file for your course project report.

Create a new code chunk (the keyboard shortcut is CTRL + ALT + I).

Give the code chunk and informative name related to the plot you will create.

Write comments to plan out the plot you wan to create. Remember to start each line of your in-code comments with a # symbol.

Your plotting plan could specify:

- The variables you want on the x and y axes
- The type of plot you want to create (e.g., bar plot, scatter plot, box plot, tree map)
- The visual styling you want to apply to the plot (e.g., colours, axis and plot titles, labels, legends, text size)

---

## References

Grolemund, G. & Wickham, H. (2017). *R for Data Science*. Retrieved from https://r4ds.had.co.nz/

Harrison, E. & Pius, R. (2020). *R for Health Data Science*. Retrieved from https://argoshare.is.ed.ac.uk/healthyr_book/reshaping-data-long-vs-wide-format.html

Wickham, H. (2010). A layered grammar of graphics. *Journal of Computational and Graphical Statistics*, *19*(1), 3–28. Retrieved from https://vita.had.co.nz/papers/layered-grammar.html